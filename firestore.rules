rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    match /{document=**} {
      allow read, write: if false;
    }

    match /sets/{setId} {
      // Allow read if: Owner OR Public/Link OR Collaborator
      allow read: if request.auth != null && (
        resource.data.ownerId == request.auth.uid ||
        resource.data.visibility in [1, 2] ||
        (resource.data.collaborators != null && request.auth.uid in resource.data.collaborators)
      );

      // Allow Create: Any authenticated user
      allow create: if request.auth != null;

      // Allow Update: Owner OR Editor collaborator
      allow update: if request.auth != null && (
        // 1. Owner can do anything
        resource.data.ownerId == request.auth.uid ||
        
        // 2. Editor can update
        (resource.data.collaborators != null && resource.data.collaborators[request.auth.uid] == 'editor') ||
        
        // 3. Joining (Public sets): Allow adding self to collaborators
        (
          resource.data.visibility in [1, 2] &&
          // Ensure we are ONLY modifying collaborators (or not removing anyone)
          // Ideally we'd verify only the user's own ID is added, but checking 'hasAll' is a decent guard
          (resource.data.collaborators == null || request.resource.data.collaborators.keys().hasAll(resource.data.collaborators.keys()))
        )
      );

      allow delete: if request.auth != null && resource.data.ownerId == request.auth.uid;
    }

    match /sets/{setId}/cards/{cardId} {
      // For list/query: permission is checked based on set membership or visibility
      allow read: if request.auth != null && (
        get(/databases/$(database)/documents/sets/$(setId)).data.ownerId == request.auth.uid ||
        get(/databases/$(database)/documents/sets/$(setId)).data.visibility in [1, 2] ||
        (get(/databases/$(database)/documents/sets/$(setId)).data.collaborators != null && 
         request.auth.uid in get(/databases/$(database)/documents/sets/$(setId)).data.collaborators)
      );

      // Allow write: Owner or Editor
      allow write: if request.auth != null && (
        get(/databases/$(database)/documents/sets/$(setId)).data.ownerId == request.auth.uid ||
        (get(/databases/$(database)/documents/sets/$(setId)).data.collaborators != null &&
         get(/databases/$(database)/documents/sets/$(setId)).data.collaborators[request.auth.uid] == 'editor')
      );
    }
  }
}
