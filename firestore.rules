rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    match /{document=**} {
      allow read, write: if false;
    }

    match /sets/{setId} {
      // Allow read if: Owner OR Public/Link OR Collaborator
      allow read: if request.auth != null && (
        resource.data.ownerId == request.auth.uid ||
        resource.data.visibility in [1, 2] ||
        (resource.data.collaborators != null && request.auth.uid in resource.data.collaborators)
      );

      // Allow Create: Any authenticated user
      allow create: if request.auth != null;

      // Allow Update: Owner OR Editor collaborator
      allow update: if request.auth != null && (
        resource.data.ownerId == request.auth.uid ||
        (resource.data.collaborators != null && resource.data.collaborators[request.auth.uid] == 'editor') ||
        // Allow adding self as collaborator if set is link-shared
        (request.resource.data.collaborators.keys().hasAll(resource.data.collaborators.keys()) && 
         resource.data.visibility in [1, 2])
      );

      allow delete: if request.auth != null && resource.data.ownerId == request.auth.uid;
    }

    match /sets/{setId}/cards/{cardId} {
      // For list/query: permission is checked based on set membership or visibility
      // To simplify and avoid the "rules are not filters" error on broad queries,
      // we check the parent set document permissions.
      allow read: if request.auth != null && (
        get(/databases/$(database)/documents/sets/$(setId)).data.ownerId == request.auth.uid ||
        get(/databases/$(database)/documents/sets/$(setId)).data.visibility in [1, 2] ||
        request.auth.uid in get(/databases/$(database)/documents/sets/$(setId)).data.collaborators
      );

      // Allow write: Owner or Editor
      allow write: if request.auth != null && (
        get(/databases/$(database)/documents/sets/$(setId)).data.ownerId == request.auth.uid ||
        get(/databases/$(database)/documents/sets/$(setId)).data.collaborators[request.auth.uid] == 'editor'
      );
    }
  }
}
